<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Serial Port Reader</title>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.15.0/dist/plotly.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #dataContainer { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; width: 100%; }
    #chart { height: 400px; width: 100%; }
  </style>
</head>
<body>

  <h1>Port Série et Analyse de Fréquences</h1>

  <!-- Sélectionner un port série et un baudrate -->
  <div>
    <label for="baudrateSelect">Baudrate : </label>
    <select id="baudrateSelect">
      <option value="9600">9600</option>
      <option value="115200">115200</option>
      <option value="250000">250000</option>
    </select>

    <label for="portSelect">Port série : </label>
    <select id="portSelect"></select>

    <button id="connectBtn">Connecter</button>
    <button id="disconnectBtn" disabled>Déconnecter</button>
  </div>

  <br/>

  <!-- Affichage des données -->
  <div>
    <label for="columnSelect">Sélectionner une colonne :</label>
    <select id="columnSelect">
      <option value="0">Colonne 1 (Index 0)</option>
      <option value="1">Colonne 2 (Index 1)</option>
      <option value="2">Colonne 3 (Index 2)</option>
      <option value="3">Colonne 4 (Index 3)</option>
      <option value="4">Colonne 5 (Index 4)</option>
      <option value="5">Colonne 6 (Index 5)</option>
    </select>
  </div>

  <!-- Données affichées -->
  <div id="dataContainer"></div>

  <!-- Boutons -->
  <div>
    <button id="clearDataBtn">Effacer les données</button>
    <button id="plotBtn">Afficher le spectre de fréquence</button>
  </div>

  <!-- Graphique -->
  <div id="chart"></div>

  <script>
    let allData = []; // Stocke toutes les données reçues
    let autoScroll = true; // Variable pour activer/désactiver le défilement automatique
    let serialPort = null; // Port série

    // Fonction pour ajouter des données à la liste
    function addData(data) {
      allData.push(data);
      if (autoScroll) {
        // Affichage des dernières données dans le conteneur
        const dataContainer = document.getElementById('dataContainer');
        dataContainer.innerHTML += `${data.join(' ')}<br>`;
        dataContainer.scrollTop = dataContainer.scrollHeight;
      }
    }

    // Connexion au port série
    document.getElementById('connectBtn').addEventListener('click', async () => {
      // Connexion au port série via Web Serial API (implémentation simplifiée)
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: parseInt(document.getElementById('baudrateSelect').value) });
        serialPort = port;

        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;

        // Lecture des données du port série (implémentation simplifiée)
        const reader = port.readable.getReader();
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          const receivedData = new TextDecoder().decode(value);
          const data = receivedData.split('\n').map(line => line.split(';'));
          data.forEach(addData);
        }
      } catch (error) {
        console.error('Erreur de connexion au port série:', error);
      }
    });

    // Déconnexion du port série
    document.getElementById('disconnectBtn').addEventListener('click', () => {
      if (serialPort) {
        serialPort.close();
        serialPort = null;
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
      }
    });

    // Effacer les données de l'affichage
    document.getElementById('clearDataBtn').addEventListener('click', () => {
      document.getElementById('dataContainer').innerHTML = '';
    });

    // Afficher le spectre de fréquence
    document.getElementById('plotBtn').addEventListener('click', () => {
      const columnIndex = parseInt(document.getElementById('columnSelect').value);
      const dataColumn = allData.map(data => parseFloat(data[columnIndex])).filter(value => !isNaN(value));

      if (dataColumn.length === 0) {
        alert('Aucune donnée valide dans cette colonne.');
        return;
      }

      // Calcul de la FFT (Transformée de Fourier)
      const fftData = fft(dataColumn);
      const freqs = fftData.map((value, index) => index * 256 / dataColumn.length); // Fréquences correspondantes à la FFT
      const magnitudes = fftData.map(value => Math.abs(value));

      // Affichage du graphique
      const trace = {
        x: freqs,
        y: magnitudes,
        type: 'scatter',
        mode: 'lines',
        name: 'Spectre de fréquence'
      };

      const layout = {
        title: 'Spectre de fréquence',
        xaxis: { title: 'Fréquence (Hz)' },
        yaxis: { title: 'Amplitude' },
      };

      Plotly.newPlot('chart', [trace], layout);
    });

    // Fonction FFT (transformée de Fourier)
    function fft(inputData) {
      const N = inputData.length;
      const result = new Array(N);
      for (let k = 0; k < N; k++) {
        result[k] = 0;
        for (let n = 0; n < N; n++) {
          result[k] += inputData[n] * Math.cos((2 * Math.PI * k * n) / N) - inputData[n] * Math.sin((2 * Math.PI * k * n) / N);
        }
      }
      return result;
    }
  </script>
</body>
</html>
